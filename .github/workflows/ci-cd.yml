name: .NET CI/CD Pipeline with Allure Reports

on:
  push:
    branches: [ main, lab_test_1 ]
  pull_request:
    branches: [ main, lab_test_1 ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '7.0.x'
  ALLURE_VERSION: '2.24.1'

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Find solution and project files
      run: |
        echo "Solution files:"
        find . -name "*.sln"
        echo "Project files:"
        find . -name "*.csproj"
        echo "Test project files:"
        find . -name "*Tests*.csproj"
      
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Run unit tests with Allure
      run: |
        dotnet test --filter Category=Unit --configuration Release --no-build --verbosity normal \
        --logger "trx;LogFileName=unit-test-results.trx" \
        --logger "console;verbosity=normal" \
        --results-directory TestResults/Unit
      working-directory: ./FlowerShop
      env:
        ALLURE_RESULTS_DIR: TestResults/Unit/allure-results
      continue-on-error: false
      
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: FlowerShop/TestResults/Unit/
        retention-days: 30
        
    - name: Upload Allure results for unit tests
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-allure-results
        path: FlowerShop/TestResults/Unit/allure-results/
        retention-days: 30

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: needs.unit-tests.result == 'success'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 5432
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
    - name: Initialize test database
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
        
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Run integration tests with Allure
      env:
        TEST_CONNECTION_STRING: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true"
        ALLURE_RESULTS_DIR: TestResults/Integration/allure-results
      run: |
        dotnet test --filter Category=Integration --configuration Release --no-build --verbosity normal \
        --logger "trx;LogFileName=integration-test-results.trx" \
        --logger "console;verbosity=normal" \
        --results-directory TestResults/Integration
      working-directory: ./FlowerShop
      continue-on-error: false
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: FlowerShop/TestResults/Integration/
        retention-days: 30
        
    - name: Upload Allure results for integration tests
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-allure-results
        path: FlowerShop/TestResults/Integration/allure-results/
        retention-days: 30
        
    - name: Cleanup test database
      if: always()
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'flowershoptest' AND pid <> pg_backend_pid();"
        sleep 2
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "DROP DATABASE IF EXISTS flowershoptest;"
        echo "Test database cleanup completed"

  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: needs.integration-tests.result == 'success'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 5432
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
    - name: Initialize test database
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
        
    - name: Verify project structure
      run: |
        echo "=== Current directory ==="
        pwd
        ls -la
        echo "=== FlowerShop directory ==="
        ls -la FlowerShop/ || echo "FlowerShop directory not found"
        echo "=== Looking for .csproj files ==="
        find . -name "*.csproj" | head -10
        
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Build and run application for E2E tests
      run: |
        echo "Current directory: $(pwd)"
        echo "Starting application from FlowerShop directory..."
        cd FlowerShop
        dotnet run --configuration Release --no-build &
        echo "Application starting in background..."
        # –î–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–∞–ø—É—Å–∫
        sleep 25
      working-directory: ./
      env:
        ASPNETCORE_ENVIRONMENT: Test
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432"
        
    - name: Wait for application to start
      run: |
        echo "Waiting for application to start..."
        for i in {1..40}; do
          # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã –∏ endpoints
          if curl -f http://localhost:5000/health 2>/dev/null || \
             curl -f http://localhost:5000/api/health 2>/dev/null || \
             curl -f http://localhost:5000/swagger 2>/dev/null || \
             curl -f http://localhost:5000 2>/dev/null || \
             curl -f http://localhost:5001/health 2>/dev/null || \
             curl -f http://localhost:5001 2>/dev/null || \
             curl -f http://localhost:8080/health 2>/dev/null || \
             curl -f http://localhost:8080 2>/dev/null; then
            echo "‚úÖ Application is ready and responding"
            break
          fi
          echo "Waiting for application... ($i/40)"
          sleep 3
        done
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Å–º–æ—Ç—Ä–∏–º –ø—Ä–æ—Ü–µ—Å—Å—ã
        echo "=== Checking running processes ==="
        ps aux | grep dotnet || echo "No dotnet processes found"
        
    - name: Run E2E tests with Allure
      env:
        TEST_CONNECTION_STRING: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true"
        BASE_URL: "http://localhost:5000"
        ALLURE_RESULTS_DIR: TestResults/E2E/allure-results
      run: |
        dotnet test --filter Category=E2E --configuration Release --no-build --verbosity normal \
        --logger "trx;LogFileName=e2e-test-results.trx" \
        --logger "console;verbosity=normal" \
        --results-directory TestResults/E2E
      working-directory: ./FlowerShop
      continue-on-error: false
      
    - name: Stop application
      if: always()
      run: |
        echo "Stopping application..."
        # –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        pkill -f "dotnet.*run" || true
        sleep 3
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å
        if pgrep -f "dotnet.*run" > /dev/null; then
          echo "Forcing stop..."
          pkill -9 -f "dotnet.*run" || true
        fi
        
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: FlowerShop/TestResults/E2E/
        retention-days: 30
        
    - name: Upload Allure results for E2E tests
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-allure-results
        path: FlowerShop/TestResults/E2E/allure-results/
        retention-days: 30
        
    - name: Cleanup test database
      if: always()
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'flowershoptest' AND pid <> pg_backend_pid();"
        sleep 2
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "DROP DATABASE IF EXISTS flowershoptest;"
        echo "Test database cleanup completed"

  allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: 
      - unit-tests
      - integration-tests  
      - e2e-tests
    if: always()
    
    permissions:
      pages: write
      id-token: write
      contents: read
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Setup Java for Allure
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: Install Allure Commandline
      run: |
        sudo wget -q https://github.com/allure-framework/allure2/releases/download/${{ env.ALLURE_VERSION }}/allure-${{ env.ALLURE_VERSION }}.tgz
        sudo tar -zxvf allure-${{ env.ALLURE_VERSION }}.tgz -C /opt/
        sudo ln -sf /opt/allure-${{ env.ALLURE_VERSION }}/bin/allure /usr/bin/allure
        allure --version
        
    - name: Prepare Allure results
      run: |
        echo "Preparing Allure results..."
        mkdir -p combined-allure-results
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        echo "Copying test results..."
        find artifacts -name "*.xml" -exec cp {} combined-allure-results/ \; 2>/dev/null || true
        find artifacts -name "*.json" -exec cp {} combined-allure-results/ \; 2>/dev/null || true
        find artifacts -name "*.txt" -exec cp {} combined-allure-results/ \; 2>/dev/null || true
        find artifacts -name "*.png" -exec cp {} combined-allure-results/ \; 2>/dev/null || true
        find artifacts -name "*.jpg" -exec cp {} combined-allure-results/ \; 2>/dev/null || true
        
        # –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∑–∞–≥–ª—É—à–∫—É –±–µ–∑ HEREDOC
        if [ ! "$(ls -A combined-allure-results)" ]; then
          echo "No test results found, creating placeholder..."
          echo '<?xml version="1.0" encoding="UTF-8"?>' > combined-allure-results/placeholder-result.xml
          echo '<testsuite name="No Tests Executed" tests="0" failures="0" errors="0" skipped="0" time="0">' >> combined-allure-results/placeholder-result.xml
          echo '  <properties>' >> combined-allure-results/placeholder-result.xml
          echo '    <property name="Allure" value="Report Generation"/>' >> combined-allure-results/placeholder-result.xml
          echo '  </properties>' >> combined-allure-results/placeholder-result.xml
          echo '</testsuite>' >> combined-allure-results/placeholder-result.xml
        fi
        
        # –°–æ–∑–¥–∞–µ–º environment —Ñ–∞–π–ª –¥–ª—è Allure
        echo "OS=Ubuntu Latest" > combined-allure-results/environment.properties
        echo "DotNet.Version=${{ env.DOTNET_VERSION }}" >> combined-allure-results/environment.properties
        echo "GitHub.Runner=Ubuntu" >> combined-allure-results/environment.properties
        echo "Branch=${{ github.ref }}" >> combined-allure-results/environment.properties
        echo "Commit=${{ github.sha }}" >> combined-allure-results/environment.properties
        echo "Workflow=${{ github.workflow }}" >> combined-allure-results/environment.properties
        echo "Run.Number=${{ github.run_number }}" >> combined-allure-results/environment.properties
        
        echo "Allure results prepared:"
        ls -la combined-allure-results/
        echo "Total files: $(find combined-allure-results -type f | wc -l)"
        
    - name: Generate Allure Report
      run: |
        echo "Generating Allure report..."
        allure generate combined-allure-results --clean -o allure-report
        echo "Allure report generated successfully"
        echo "Report contents:"
        ls -la allure-report/
        
    - name: Upload Allure Report as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report/
        retention-days: 30

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: allure-report
    if: needs.allure-report.result == 'success' && github.event_name == 'push'
    
    permissions:
      pages: write
      id-token: write
      contents: read
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download Allure report artifact
      uses: actions/download-artifact@v4
      with:
        name: allure-report
        path: ./public
        
    - name: Verify Allure report files
      run: |
        echo "=== Checking Allure report contents ==="
        ls -la ./public/ || echo "No public directory"
        find ./public -name "*.html" | head -5 || echo "No HTML files found"
        echo "=== File count ==="
        find ./public -type f | wc -l
        
    - name: Setup Pages
      uses: actions/configure-pages@v3
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./public
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: 
      - unit-tests
      - integration-tests
      - e2e-tests
      - allure-report
    if: always()
    
    steps:
    - name: Generate Test Summary
      run: |
        echo "## üß™ Comprehensive Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üìä Test Execution Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        
        # Unit Tests
        if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
          echo "| ‚úÖ Unit Tests | ‚úÖ Success | All unit tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.unit-tests.result }}" == "failure" ]]; then
          echo "| ‚ùå Unit Tests | ‚ùå Failed | Check unit test results |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ‚ö†Ô∏è Unit Tests | ‚ùì ${{ needs.unit-tests.result }} | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Integration Tests
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "| ‚úÖ Integration Tests | ‚úÖ Success | All integration tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
          echo "| ‚ùå Integration Tests | ‚ùå Failed | Check integration test results |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.integration-tests.result }}" == "skipped" ]]; then
          echo "| ‚è≠Ô∏è Integration Tests | ‚è≠Ô∏è Skipped | Previous job failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ‚ö†Ô∏è Integration Tests | ‚ùì ${{ needs.integration-tests.result }} | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # E2E Tests
        if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "| ‚úÖ E2E Tests | ‚úÖ Success | All end-to-end tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.e2e-tests.result }}" == "failure" ]]; then
          echo "| ‚ùå E2E Tests | ‚ùå Failed | Check E2E test results |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
          echo "| ‚è≠Ô∏è E2E Tests | ‚è≠Ô∏è Skipped | Previous job failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ‚ö†Ô∏è E2E Tests | ‚ùì ${{ needs.e2e-tests.result }} | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìà Allure Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.allure-report.result }}" == "success" ]]; then
          echo "**üéâ Allure Report Generated Successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìñ **View Report:** Download 'allure-report' artifact" >> $GITHUB_STEP_SUMMARY
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ Pages —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω
          if [[ "${{ needs.deploy-pages.result }}" == "success" ]]; then
            echo "üåê **Live Report:** ${{ needs.deploy-pages.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "üì¶ **Download Artifact:** 'allure-report' from artifacts section" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**‚ùå Allure Report Generation Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the allure-report job logs for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üöÄ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && "${{ needs.integration-tests.result }}" == "success" && "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "**üéä All tests passed successfully!** The application is ready for deployment. üöÄ" >> $GITHUB_STEP_SUMMARY
        else
          echo "**‚ö†Ô∏è Some tests failed or were skipped.** Please review the test results above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üîß Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the detailed Allure report" >> $GITHUB_STEP_SUMMARY
          echo "2. Review failed tests and fix the issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Download test artifacts for detailed analysis" >> $GITHUB_STEP_SUMMARY
          echo "4. Re-run the pipeline after fixes" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*üìã Report generated automatically by GitHub Actions*" >> $GITHUB_STEP_SUMMARY