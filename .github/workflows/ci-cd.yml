name: .NET CI/CD Pipeline

on:
  push:
    branches: [ main, lab_test_1 ]
  pull_request:
    branches: [ main, lab_test_1 ]

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 7.0
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'
        
    - name: Find solution and project files
      run: |
        echo "Solution files:"
        find . -name "*.sln"
        echo "Project files:"
        find . -name "*.csproj"
        echo "Test project files:"
        find . -name "*Tests*.csproj"
      
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Run unit tests
      run: |
        dotnet test --filter Category=Unit --configuration Release --no-build --verbosity normal \
        --logger "trx;LogFileName=unit-test-results.trx" \
        --results-directory TestResults/Unit
      working-directory: ./FlowerShop
      continue-on-error: false
      
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: FlowerShop/TestResults/Unit/
        retention-days: 30

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 5432
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 7.0
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'
        
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
    - name: Initialize test database
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
        
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Run integration tests
      env:
        TEST_CONNECTION_STRING: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true"
      run: |
        dotnet test --filter Category=Integration --configuration Release --no-build --verbosity normal \
        --logger "trx;LogFileName=integration-test-results.trx" \
        --results-directory TestResults/Integration
      working-directory: ./FlowerShop
      continue-on-error: false
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: FlowerShop/TestResults/Integration/
        retention-days: 30
        
    - name: Cleanup test database
      if: always()
      run: |
        # Завершаем все активные соединения с тестовой БД
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'flowershoptest' AND pid <> pg_backend_pid();"
        
        # Небольшая задержка для завершения процессов
        sleep 2
        
        # Удаляем тестовую БД
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "DROP DATABASE IF EXISTS flowershoptest;"
        
        echo "Test database cleanup completed"

  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 5432
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 7.0
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '7.0.x'
        
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
    - name: Initialize test database
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
        
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Run E2E tests
      env:
        TEST_CONNECTION_STRING: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true"
      run: |
        dotnet test --filter Category=E2E --configuration Release --no-build --verbosity normal \
        --logger "trx;LogFileName=e2e-test-results.trx" \
        --results-directory TestResults/E2E
      working-directory: ./FlowerShop
      continue-on-error: false
      
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: FlowerShop/TestResults/E2E/
        retention-days: 30
        
    - name: Cleanup test database
      if: always()
      run: |
        # Завершаем все активные соединения с тестовой БД
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'flowershoptest' AND pid <> pg_backend_pid();"
        
        # Небольшая задержка для завершения процессов
        sleep 2
        
        # Удаляем тестовую БД
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "DROP DATABASE IF EXISTS flowershoptest;"
        
        echo "Test database cleanup completed"

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: always()
    
    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: artifacts/**/*.trx
        reporter: dotnet-trx