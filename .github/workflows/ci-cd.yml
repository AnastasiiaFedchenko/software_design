name: .NET CI/CD Pipeline with Allure Reports

on:
  push:
    branches: [ main, lab_test_1, lab_test_5_2 ]
  pull_request:
    branches: [ main, lab_test_1, lab_test_5_2 ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '7.0.x'
  ALLURE_VERSION: '2.24.1'

jobs:
  quality-checks:
    name: Code Style and Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Restore dotnet tools
      run: dotnet tool restore
      working-directory: ./FlowerShop
      
    - name: Code style check
      run: dotnet format --verify-no-changes
      working-directory: ./FlowerShop
      
    - name: Static analysis (Cyclomatic/Halstead)
      run: dotnet run --project tools/StaticAnalysis -- --max-cyclomatic 10 --out-dir analysis
      working-directory: ./FlowerShop

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    needs: quality-checks
    if: needs.quality-checks.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Find solution and project files
      run: |
        echo "Solution files:"
        find . -name "*.sln"
        echo "Project files:"
        find . -name "*.csproj"
        echo "Test project files:"
        find . -name "*Tests*.csproj"
      
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Run unit tests with Allure
      run: |
        dotnet test ./Tests/Tests.csproj --configuration Release --verbosity normal \
        --logger "trx;LogFileName=unit-test-results.trx" \
        --logger "console;verbosity=normal" \
        --results-directory TestResults/Unit
      working-directory: ./FlowerShop
      continue-on-error: false
      
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: FlowerShop/TestResults/Unit/
        retention-days: 30
        
    - name: Upload Allure results for unit tests
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-allure-results
        path: FlowerShop/Tests/bin/Release/net7.0/allure-results/
        retention-days: 30

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: needs.unit-tests.result == 'success'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 5432
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
    - name: Initialize test database
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
        
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Run integration tests with Allure
      env:
        TEST_CONNECTION_STRING: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true"
      run: |
        dotnet test ./Integration.Tests/Integration.Tests.csproj --configuration Release --verbosity normal \
        --logger "trx;LogFileName=integration-test-results.trx" \
        --logger "console;verbosity=normal" \
        --results-directory TestResults/Integration
      working-directory: ./FlowerShop
      continue-on-error: false
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: FlowerShop/TestResults/Integration/
        retention-days: 30
        
    - name: Upload Allure results for integration tests
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-allure-results
        path: FlowerShop/Integration.Tests/bin/Release/net7.0/allure-results/
        retention-days: 30
        
    - name: Cleanup test database
      if: always()
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'flowershoptest' AND pid <> pg_backend_pid();"
        sleep 2
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "DROP DATABASE IF EXISTS flowershoptest;"
        echo "Test database cleanup completed"

  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: needs.integration-tests.result == 'success'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 5432
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
    - name: Initialize test database
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
        
    - name: Verify project structure
      run: |
        echo "=== Current directory ==="
        pwd
        ls -la
        echo "=== FlowerShop directory ==="
        ls -la FlowerShop/ || echo "FlowerShop directory not found"
        echo "=== Looking for .csproj files ==="
        find . -name "*.csproj" | head -10
        
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Build and run application for E2E tests
      run: |
        echo "Current directory: $(pwd)"
        echo "Starting application from FlowerShop directory..."
        cd FlowerShop
        dotnet run --configuration Release --no-build &
        echo "Application starting in background..."
        sleep 25
      working-directory: ./
      env:
        ASPNETCORE_ENVIRONMENT: Test
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432"
        AuthSettings__ShowTwoFactorCode: "true"
        AuthSettings__ShowRecoveryCode: "true"
        
    - name: Wait for application to start
      run: |
        echo "Waiting for application to start..."
        for i in {1..40}; do
          if curl -f http://localhost:5000/health 2>/dev/null || \
             curl -f http://localhost:5000/api/health 2>/dev/null || \
             curl -f http://localhost:5000/swagger 2>/dev/null || \
             curl -f http://localhost:5000 2>/dev/null || \
             curl -f http://localhost:5001/health 2>/dev/null || \
             curl -f http://localhost:5001 2>/dev/null || \
             curl -f http://localhost:8080/health 2>/dev/null || \
             curl -f http://localhost:8080 2>/dev/null; then
            echo "âœ… Application is ready and responding"
            break
          fi
          echo "Waiting for application... ($i/40)"
          sleep 3
        done
        
        echo "=== Checking running processes ==="
        ps aux | grep dotnet || echo "No dotnet processes found"
        
    - name: Run E2E tests with Allure
      env:
        TEST_CONNECTION_STRING: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true"
        BASE_URL: "http://localhost:5000"
        E2E_USER_ID: "9001"
        E2E_USER_PASSWORD: ${{ secrets.E2E_USER_PASSWORD }}
        E2E_NEW_PASSWORD: ${{ secrets.E2E_NEW_PASSWORD }}
      run: |
        dotnet test ./E2E.Tests/E2E.Tests.csproj --configuration Release --verbosity normal \
        --filter "FullyQualifiedName!~AuthenticationBddTests" \
        --logger "trx;LogFileName=e2e-test-results.trx" \
        --logger "console;verbosity=normal" \
        --results-directory TestResults/E2E
      working-directory: ./FlowerShop
      continue-on-error: false

  auth-e2e-tests:
    name: Run Auth E2E Tests (BDD)
    runs-on: ubuntu-latest
    needs: integration-tests
    if: needs.integration-tests.result == 'success'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 5432
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
        
    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U postgres; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
    - name: Initialize test database
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
        
    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop
      
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop
      
    - name: Build and run application for Auth E2E tests
      run: |
        echo "Starting application from FlowerShop directory..."
        cd FlowerShop
        dotnet run --configuration Release --no-build &
        sleep 25
      working-directory: ./
      env:
        ASPNETCORE_ENVIRONMENT: Test
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432"
        AuthSettings__ShowTwoFactorCode: "false"
        AuthSettings__ShowRecoveryCode: "false"
        EmailSettings__SmtpHost: ${{ secrets.SMTP_HOST }}
        EmailSettings__SmtpPort: ${{ secrets.SMTP_PORT }}
        EmailSettings__SmtpUser: ${{ secrets.SMTP_USER }}
        EmailSettings__SmtpPassword: ${{ secrets.SMTP_PASSWORD }}
        EmailSettings__FromEmail: ${{ secrets.SMTP_FROM }}
        EmailSettings__AdminEmail: ${{ secrets.E2E_EMAIL_USER }}
        
    - name: Run Auth BDD E2E tests
      env:
        TEST_CONNECTION_STRING: "Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true"
        BASE_URL: "http://localhost:5000"
        E2E_USE_FACTORY: "true"
        E2E_USER_ID: "9001"
        E2E_USER_PASSWORD: ${{ secrets.E2E_USER_PASSWORD }}
        E2E_NEW_PASSWORD: ${{ secrets.E2E_NEW_PASSWORD }}
        E2E_EMAIL_USER: ${{ secrets.E2E_EMAIL_USER }}
        E2E_EMAIL_PASSWORD: ${{ secrets.E2E_EMAIL_PASSWORD }}
        E2E_EMAIL_HOST: ${{ secrets.E2E_EMAIL_HOST }}
        E2E_EMAIL_PORT: ${{ secrets.E2E_EMAIL_PORT }}
        E2E_EMAIL_SSL: ${{ secrets.E2E_EMAIL_SSL }}
      run: |
        dotnet test ./E2E.Tests/E2E.Tests.csproj --configuration Release --verbosity normal \
        --filter "FullyQualifiedName~AuthenticationBddTests" \
        --logger "trx;LogFileName=auth-e2e-test-results.trx" \
        --logger "console;verbosity=normal" \
        --results-directory TestResults/AuthE2E
      working-directory: ./FlowerShop
      continue-on-error: false
      
    - name: Stop application
      if: always()
      run: |
        pkill -f "dotnet.*run" || true
        sleep 3
        if pgrep -f "dotnet.*run" > /dev/null; then
          pkill -9 -f "dotnet.*run" || true
        fi
        
    - name: Upload Auth E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: auth-e2e-test-results
        path: FlowerShop/TestResults/AuthE2E/
        retention-days: 30
      
    - name: Stop application
      if: always()
      run: |
        echo "Stopping application..."
        pkill -f "dotnet.*run" || true
        sleep 3
        if pgrep -f "dotnet.*run" > /dev/null; then
          echo "Forcing stop..."
          pkill -9 -f "dotnet.*run" || true
        fi
        
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: FlowerShop/TestResults/E2E/
        retention-days: 30
        
    - name: Upload Allure results for E2E tests
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-allure-results
        path: FlowerShop/E2E.Tests/bin/Release/net7.0/allure-results/
        retention-days: 30
        
    - name: Cleanup test database
      if: always()
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'flowershoptest' AND pid <> pg_backend_pid();"
        sleep 2
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "DROP DATABASE IF EXISTS flowershoptest;"
        echo "Test database cleanup completed"

  resource-benchmark:
    name: Resource Usage Benchmark (Tracing/Logging)
    runs-on: ubuntu-latest
    needs:
      - e2e-tests
      - auth-e2e-tests
    if: needs.e2e-tests.result == 'success' && needs.auth-e2e-tests.result == 'success'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 5432
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Initialize test database
      run: |
        PGPASSWORD=5432 psql -h localhost -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"

    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./FlowerShop

    - name: Build solution
      run: dotnet build --no-restore --configuration Release
      working-directory: ./FlowerShop

    - name: Measure resource usage
      run: |
        set -euo pipefail

        APP_URL="http://localhost:5000"
        CONN_STR="Host=localhost;Port=5432;Database=flowershoptest;Username=postgres;Password=5432"
        CLK_TCK=$(getconf CLK_TCK)

        mkdir -p TestResults/ResourceBenchmark
        CSV_PATH="TestResults/ResourceBenchmark/resource-metrics.csv"
        echo "scenario,tracing,logging,cpu_seconds,max_rss_kb" > "$CSV_PATH"

        run_scenario() {
          local scenario="$1"
          local tracing="$2"
          local logging="$3"

          echo "=== Running scenario: $scenario (tracing=$tracing, logging=$logging) ==="
          local log_env=()
          if [[ "$logging" == "extended" ]]; then
            log_env+=("Serilog__MinimumLevel__Default=Debug")
            log_env+=("Serilog__MinimumLevel__Override__Microsoft=Information")
            log_env+=("Serilog__MinimumLevel__Override__System=Information")
          fi

          ASPNETCORE_ENVIRONMENT=Test \
          ASPNETCORE_URLS="$APP_URL" \
          ConnectionStrings__DefaultConnection="$CONN_STR" \
          Jaeger__Enabled="$tracing" \
          Jaeger__Host="localhost" \
          Jaeger__Port="6831" \
          "${log_env[@]}" \
          dotnet run --configuration Release --no-build --project WebApp/WebApp.csproj > /tmp/app-$scenario.log 2>&1 &

          local app_pid=$!
          local ready=0
          for i in {1..40}; do
            if curl -s -o /dev/null "$APP_URL/Account/Login"; then
              ready=1
              break
            fi
            if ! kill -0 "$app_pid" 2>/dev/null; then
              echo "App exited early for scenario $scenario"
              tail -200 /tmp/app-$scenario.log || true
              exit 1
            fi
            sleep 1
          done
          if [[ "$ready" -ne 1 ]]; then
            echo "App did not become ready for scenario $scenario"
            tail -200 /tmp/app-$scenario.log || true
            kill "$app_pid" || true
            exit 1
          fi

          local start_ticks
          start_ticks=$(awk '{print $14 + $15}' "/proc/$app_pid/stat")
          local max_rss_kb=0
          for i in {1..200}; do
            curl -s -o /dev/null "$APP_URL/Account/Login"
            if ! kill -0 "$app_pid" 2>/dev/null; then
              echo "App exited during sampling for scenario $scenario"
              tail -200 /tmp/app-$scenario.log || true
              exit 1
            fi
            local rss_kb
            rss_kb=$(awk '/VmRSS/{print $2}' "/proc/$app_pid/status" || echo 0)
            if [[ "$rss_kb" -gt "$max_rss_kb" ]]; then
              max_rss_kb="$rss_kb"
            fi
          done
          local end_ticks
          end_ticks=$(awk '{print $14 + $15}' "/proc/$app_pid/stat")

          local delta_ticks=$((end_ticks - start_ticks))
          local cpu_seconds
          cpu_seconds=$(awk -v d="$delta_ticks" -v t="$CLK_TCK" 'BEGIN { printf "%.3f", d / t }')

          echo "$scenario,$tracing,$logging,$cpu_seconds,$max_rss_kb" >> "$CSV_PATH"

          kill "$app_pid" || true
          sleep 2
          if kill -0 "$app_pid" 2>/dev/null; then
            kill -9 "$app_pid" || true
          fi
        }

        run_scenario "trace_off_log_default" "false" "default"
        run_scenario "trace_on_log_default" "true" "default"
        run_scenario "trace_off_log_extended" "false" "extended"
        run_scenario "trace_on_log_extended" "true" "extended"

        awk -F, '
          NR>1 { cpu[$1]=$4; rss[$1]=$5 }
          END {
            printf "| Scenario | Tracing | Logging | CPU (s) | Max RSS (MB) |\n"
            printf "|---|---|---|---|---|\n"
            printf "| Trace Off + Log Default | off | default | %.3f | %.2f |\n", cpu["trace_off_log_default"], rss["trace_off_log_default"]/1024
            printf "| Trace On + Log Default | on | default | %.3f | %.2f |\n", cpu["trace_on_log_default"], rss["trace_on_log_default"]/1024
            printf "| Trace Off + Log Extended | off | extended | %.3f | %.2f |\n", cpu["trace_off_log_extended"], rss["trace_off_log_extended"]/1024
            printf "| Trace On + Log Extended | on | extended | %.3f | %.2f |\n", cpu["trace_on_log_extended"], rss["trace_on_log_extended"]/1024
            printf "\n"
            printf "| Delta | CPU (s) | Max RSS (MB) |\n"
            printf "|---|---|---|\n"
            printf "| Tracing overhead (default log) | %.3f | %.2f |\n", cpu["trace_on_log_default"]-cpu["trace_off_log_default"], (rss["trace_on_log_default"]-rss["trace_off_log_default"])/1024
            printf "| Tracing overhead (extended log) | %.3f | %.2f |\n", cpu["trace_on_log_extended"]-cpu["trace_off_log_extended"], (rss["trace_on_log_extended"]-rss["trace_off_log_extended"])/1024
            printf "| Logging overhead (trace off) | %.3f | %.2f |\n", cpu["trace_off_log_extended"]-cpu["trace_off_log_default"], (rss["trace_off_log_extended"]-rss["trace_off_log_default"])/1024
            printf "| Logging overhead (trace on) | %.3f | %.2f |\n", cpu["trace_on_log_extended"]-cpu["trace_on_log_default"], (rss["trace_on_log_extended"]-rss["trace_on_log_default"])/1024
          }' "$CSV_PATH" > TestResults/ResourceBenchmark/resource-metrics.md
      working-directory: ./FlowerShop

    - name: Upload resource benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: resource-benchmark-results
        path: FlowerShop/TestResults/ResourceBenchmark/
        retention-days: 30

  allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: 
      - unit-tests
      - integration-tests  
      - auth-e2e-tests
      - e2e-tests
    if: always()
    
    permissions:
      pages: write
      id-token: write
      contents: read
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Debug artifact structure
      run: |
        echo "=== Artifact structure ==="
        find artifacts -type f -name "*.json" | head -20
        echo "=== Unit allure results ==="
        ls -la artifacts/unit-allure-results/ 2>/dev/null || echo "No unit-allure-results found"
        echo "=== Integration allure results ==="
        ls -la artifacts/integration-allure-results/ 2>/dev/null || echo "No integration-allure-results found"
        echo "=== E2E allure results ==="
        ls -la artifacts/e2e-allure-results/ 2>/dev/null || echo "No e2e-allure-results found"
        
    - name: Setup Java for Allure
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: Install Allure Commandline
      run: |
        sudo wget -q https://github.com/allure-framework/allure2/releases/download/${{ env.ALLURE_VERSION }}/allure-${{ env.ALLURE_VERSION }}.tgz
        sudo tar -zxvf allure-${{ env.ALLURE_VERSION }}.tgz -C /opt/
        sudo ln -sf /opt/allure-${{ env.ALLURE_VERSION }}/bin/allure /usr/bin/allure
        allure --version
        
    - name: Prepare Allure results
      run: |
        echo "Preparing Allure results..."
        mkdir -p combined-allure-results
        
        echo "Looking for Allure results in artifacts..."
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Allure Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¸Ð· Ð²ÑÐµÑ… Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹
        for category in unit integration e2e; do
          if [ -d "artifacts/${category}-allure-results" ]; then
            echo "Copying ${category} allure results..."
            cp -r artifacts/${category}-allure-results/* combined-allure-results/ 2>/dev/null || true
          fi
        done
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¾ÑÑŒ
        echo "=== Copied Allure files ==="
        ls -la combined-allure-results/
        echo "JSON files: $(find combined-allure-results -name "*.json" | wc -l)"
        echo "Total files: $(find combined-allure-results -type f | wc -l)"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ environment.properties
        echo "Creating environment properties..."
        cat > combined-allure-results/environment.properties << EOF
        OS=Ubuntu Latest
        DotNet.Version=${{ env.DOTNET_VERSION }}
        Allure.Version=${{ env.ALLURE_VERSION }}
        GitHub.Runner=Ubuntu
        Branch=${{ github.ref }}
        Commit=${{ github.sha }}
        Workflow=${{ github.workflow }}
        Run.Number=${{ github.run_number }}
        Test.Projects=Unit,Integration,E2E
        EOF
        
    - name: Generate Allure Report
      run: |
        echo "Generating Allure report..."
        allure generate combined-allure-results --clean -o allure-report
        echo "Allure report generated successfully"
        echo "Report contents:"
        ls -la allure-report/
        
    - name: Upload Allure Report as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report/
        retention-days: 30

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: allure-report
    if: needs.allure-report.result == 'success' && github.event_name == 'push'
    
    permissions:
      pages: write
      id-token: write
      contents: read
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download Allure report artifact
      uses: actions/download-artifact@v4
      with:
        name: allure-report
        path: ./public
        
    - name: Verify Allure report files
      run: |
        echo "=== Checking Allure report contents ==="
        ls -la ./public/ || echo "No public directory"
        find ./public -name "*.html" | head -5 || echo "No HTML files found"
        echo "=== File count ==="
        find ./public -type f | wc -l
        
    - name: Setup Pages
      uses: actions/configure-pages@v3
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v4
      with:
        path: ./public
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: 
      - unit-tests
      - integration-tests
      - e2e-tests
      - resource-benchmark
      - allure-report
    if: always()
    
    steps:
    - name: Generate Test Summary
      run: |
        echo "## ðŸ§ª Comprehensive Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Test Execution Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
          echo "| âœ… Unit Tests | âœ… Success | All unit tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.unit-tests.result }}" == "failure" ]]; then
          echo "| âŒ Unit Tests | âŒ Failed | Check unit test results |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| âš ï¸ Unit Tests | â“ ${{ needs.unit-tests.result }} | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "| âœ… Integration Tests | âœ… Success | All integration tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
          echo "| âŒ Integration Tests | âŒ Failed | Check integration test results |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.integration-tests.result }}" == "skipped" ]]; then
          echo "| â­ï¸ Integration Tests | â­ï¸ Skipped | Previous job failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| âš ï¸ Integration Tests | â“ ${{ needs.integration-tests.result }} | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "| âœ… E2E Tests | âœ… Success | All end-to-end tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.e2e-tests.result }}" == "failure" ]]; then
          echo "| âŒ E2E Tests | âŒ Failed | Check E2E test results |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
          echo "| â­ï¸ E2E Tests | â­ï¸ Skipped | Previous job failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| âš ï¸ E2E Tests | â“ ${{ needs.e2e-tests.result }} | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Allure Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.allure-report.result }}" == "success" ]]; then
          echo "**ðŸŽ‰ Allure Report Generated Successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– **View Report:** Download 'allure-report' artifact" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy-pages.result }}" == "success" ]]; then
            echo "ðŸŒ **Live Report:** ${{ needs.deploy-pages.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“¦ **Download Artifact:** 'allure-report' from artifacts section" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**âŒ Allure Report Generation Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the allure-report job logs for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && "${{ needs.integration-tests.result }}" == "success" && "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "**ðŸŽŠ All tests passed successfully!** The application is ready for deployment. ðŸš€" >> $GITHUB_STEP_SUMMARY
        else
          echo "**âš ï¸ Some tests failed or were skipped.** Please review the test results above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”§ Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the detailed Allure report" >> $GITHUB_STEP_SUMMARY
          echo "2. Review failed tests and fix the issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Download test artifacts for detailed analysis" >> $GITHUB_STEP_SUMMARY
          echo "4. Re-run the pipeline after fixes" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*ðŸ“‹ Report generated automatically by GitHub Actions*" >> $GITHUB_STEP_SUMMARY

    - name: Add resource benchmark summary
      if: always()
      uses: actions/download-artifact@v4
      with:
        name: resource-benchmark-results
        path: artifacts/resource-benchmark-results

    - name: Append resource benchmark table
      if: always()
      run: |
        if [[ -f "artifacts/resource-benchmark-results/resource-metrics.md" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§® Resource Usage (Tracing/Logging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat "artifacts/resource-benchmark-results/resource-metrics.md" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§® Resource Usage (Tracing/Logging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Resource benchmark results not available._" >> $GITHUB_STEP_SUMMARY
        fi
