name: .NET CI/CD Pipeline with Docker

on:
  push:
    branches: [ main, lab_test_1, lab_test_2_with_docker ]
  pull_request:
    branches: [ main, lab_test_1, lab_test_2_with_docker ]

jobs:
  build-and-test:
    name: Build and Test with Docker
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Make scripts executable
      run: chmod +x ./scripts/*.sh
      
    - name: Build Docker images
      run: |
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð· Ñ .NET 7.0
        docker build -t flowershop-base -f Dockerfile.base .
        
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        docker build -t flowershop-app -f Dockerfile .
        
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
        docker build -t flowershop-tests -f Dockerfile.tests .
        
        echo "Docker images built successfully"
      
    - name: Run unit tests in container
      run: |
        mkdir -p TestResults/Unit
        docker run --rm \
          -v $(pwd)/TestResults:/src/TestResults \
          flowershop-tests \
          dotnet test --filter Category=Unit --configuration Release --verbosity normal \
          --logger "trx;LogFileName=unit-test-results.trx" \
          --results-directory TestResults/Unit
      
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: TestResults/Unit/
        retention-days: 30

  integration-tests:
    name: Run Integration Tests in Docker
    runs-on: ubuntu-latest
    needs: build-and-test
    if: needs.build-and-test.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build test image
      run: |
        docker build -t flowershop-tests -f Dockerfile.tests .
      
    - name: Start PostgreSQL container
      run: |
        docker run -d --name test-postgres \
          -e POSTGRES_USER=postgres \
          -e POSTGRES_PASSWORD=5432 \
          -e POSTGRES_DB=postgres \
          -p 5432:5432 \
          postgres:15
          
        # Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° PostgreSQL Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ
        echo "Waiting for PostgreSQL to start..."
        for i in {1..30}; do
          if docker exec test-postgres pg_isready -U postgres -h localhost; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
        sleep 5
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ Ð‘Ð”
        docker exec test-postgres psql -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
      
    - name: Run integration tests
      run: |
        mkdir -p TestResults/Integration
        docker run --rm \
          --link test-postgres:postgres \
          -e TEST_CONNECTION_STRING="Host=postgres;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true" \
          -v $(pwd)/TestResults:/src/TestResults \
          flowershop-tests \
          dotnet test --filter Category=Integration --configuration Release --verbosity normal \
          --logger "trx;LogFileName=integration-test-results.trx" \
          --results-directory TestResults/Integration
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: TestResults/Integration/
        retention-days: 30
        
    - name: Cleanup containers
      if: always()
      run: |
        docker stop test-postgres || true
        docker rm test-postgres || true

  e2e-tests:
    name: Run E2E Tests in Docker
    runs-on: ubuntu-latest
    needs: integration-tests
    if: needs.integration-tests.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build application image
      run: |
        docker build -t flowershop-app -f Dockerfile .
        docker build -t flowershop-tests -f Dockerfile.tests .
      
    - name: Start application stack
      run: |
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PostgreSQL
        docker run -d --name e2e-postgres \
          -e POSTGRES_USER=postgres \
          -e POSTGRES_PASSWORD=5432 \
          -e POSTGRES_DB=postgres \
          -p 5432:5432 \
          postgres:15
          
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° PostgreSQL
        echo "Waiting for PostgreSQL to start..."
        for i in {1..30}; do
          if docker exec e2e-postgres pg_isready -U postgres -h localhost; then
            echo "PostgreSQL is ready"
            break
          fi
          echo "Waiting for PostgreSQL... ($i/30)"
          sleep 2
        done
        
        sleep 5
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ Ð‘Ð”
        docker exec e2e-postgres psql -U postgres -d postgres -c "CREATE DATABASE flowershoptest;"
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        docker run -d --name flowershop-app \
          --link e2e-postgres:postgres \
          -e ConnectionStrings__DefaultConnection="Host=postgres;Port=5432;Database=flowershoptest;Username=postgres;Password=5432" \
          -p 8080:8080 \
          flowershop-app
          
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        echo "Waiting for application to start..."
        for i in {1..30}; do
          if curl -f http://localhost:8080/health > /dev/null 2>&1; then
            echo "Application is ready"
            break
          fi
          echo "Waiting for application... ($i/30)"
          sleep 5
        done
      
    - name: Run E2E tests
      run: |
        mkdir -p TestResults/E2E
        docker run --rm \
          --link e2e-postgres:postgres \
          --link flowershop-app:app \
          -e TEST_CONNECTION_STRING="Host=postgres;Port=5432;Database=flowershoptest;Username=postgres;Password=5432;Include Error Detail=true" \
          -e API_BASE_URL="http://app:8080" \
          -v $(pwd)/TestResults:/src/TestResults \
          flowershop-tests \
          dotnet test --filter Category=E2E --configuration Release --verbosity normal \
          --logger "trx;LogFileName=e2e-test-results.trx" \
          --results-directory TestResults/E2E
      
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: TestResults/E2E/
        retention-days: 30
        
    - name: Cleanup containers
      if: always()
      run: |
        docker stop flowershop-app e2e-postgres || true
        docker rm flowershop-app e2e-postgres || true

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: 
      - build-and-test
      - integration-tests  
      - e2e-tests
    if: always()
    
    permissions:
      checks: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create valid skipped test result files
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ðµ TRX Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ð½Ð°Ð±Ð¾Ñ€Ð¾Ð¼ Ñ‚ÐµÑÑ‚Ð¾Ð²
        mkdir -p artifacts/skipped
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²
        mkdir -p artifacts/unit-test-results
        mkdir -p artifacts/integration-test-results  
        mkdir -p artifacts/e2e-test-results
        
        # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾Ð³Ð¾ TRX Ñ„Ð°Ð¹Ð»Ð° Ñ Ð¾Ð´Ð½Ð¸Ð¼ Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ð¼ Ñ‚ÐµÑÑ‚Ð¾Ð¼
        create_skipped_trx() {
          local test_type=$1
          local filename=$2
          local run_id=$(uuidgen)
          local creation_time=$(date -u +"%Y-%m-%dT%H:%M:%S.0000000Z")
          local finish_time=$(date -u +"%Y-%m-%dT%H:%M:%S.0000000Z")
          
          cat > "$filename" << EOF
        <?xml version="1.0" encoding="utf-8"?>
        <TestRun id="$run_id" name="$test_type Tests" runUser="GitHub Actions" xmlns="http://microsoft.com/schemas/VisualStudio/TeamTest/2010">
          <Times creation="$creation_time" finish="$finish_time"/>
          <ResultSummary outcome="NotExecuted">
            <Counters total="1" executed="0" passed="0" failed="0" error="0" timeout="0" aborted="0" inconclusive="0" passedButRunAborted="0" notRunnable="0" notExecuted="1" disconnected="0" warning="0" completed="0" inProgress="0" pending="0"/>
            <Output>
              <StdOut>Test suite was skipped due to previous job failure: $test_type Tests</StdOut>
            </Output>
          </ResultSummary>
          <TestDefinitions>
            <UnitTest name="Skipped_${test_type}_Test" storage="dummy.dll" id="$(uuidgen)">
              <Execution id="$(uuidgen)"/>
              <TestMethod codeBase="dummy.dll" className="SkippedTests" name="Skipped_${test_type}_Test"/>
            </UnitTest>
          </TestDefinitions>
          <TestLists>
            <TestList name="Results Not in a List" id="8c84fa94-04c1-424b-9868-57a2d4851a1d"/>
            <TestList name="All Loaded Results" id="19431567-8539-422a-85d7-44ee4e166bda"/>
          </TestLists>
          <TestEntries>
            <TestEntry testId="$(uuidgen)" executionId="$(uuidgen)" testListId="19431567-8539-422a-85d7-44ee4e166bda"/>
          </TestEntries>
          <Results>
            <UnitTestResult testName="Skipped_${test_type}_Test" outcome="NotExecuted" testListId="19431567-8539-422a-85d7-44ee4e166bda">
              <Output>
                <StdOut>Test was skipped because the $test_type test job did not run due to previous stage failure.</StdOut>
              </Output>
            </UnitTestResult>
          </Results>
        </TestRun>
        EOF
        }
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ jobs, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ð»Ð¸ÑÑŒ
        if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
          create_skipped_trx "Integration" "artifacts/integration-test-results/integration-test-results.trx"
          echo "Created valid skipped result for integration tests"
        fi
        
        if [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then
          create_skipped_trx "E2E" "artifacts/e2e-test-results/e2e-test-results.trx"
          echo "Created valid skipped result for E2E tests"
        fi
        
        echo "Valid skipped test result files created successfully"
      
    - name: List downloaded artifacts
      run: |
        echo "=== Artifacts structure ==="
        find artifacts -name "*.trx" -type f | head -20
        echo "=== Total TRX files found: ==="
        find artifacts -name "*.trx" -type f | wc -l

    - name: Publish Test Results for Internal PR
      if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'
      uses: dorny/test-reporter@v1
      with:
        name: Test Results
        path: artifacts/**/*.trx
        reporter: dotnet-trx
        fail-on-error: false
        
    - name: Skip Test Results for Fork PR
      if: github.event.pull_request.head.repo.full_name != github.repository && github.event_name == 'pull_request'
      run: |
        echo "Skipping test report publication for fork PR due to security restrictions"
        echo "Test artifacts are available for download in the workflow run"
        echo "Build & Unit Tests: ${{ needs.build-and-test.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}" 
        echo "E2E Tests: ${{ needs.e2e-tests.result }}"
        
    - name: Generate Detailed Test Summary
      if: always()
      run: |
        echo "## ðŸ³ Docker Test Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸš€ Job Execution Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Stage | Status | Environment | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|-------------|---------|" >> $GITHUB_STEP_SUMMARY
        
        # Build & Unit Tests
        if [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
          echo "| ðŸ”¨ Build & Unit Tests | âœ… Success | Docker Container | All unit tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.build-and-test.result }}" == "failure" ]]; then
          echo "| ðŸ”¨ Build & Unit Tests | âŒ Failed | Docker Container | Check unit test results |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ”¨ Build & Unit Tests | âš ï¸ Unknown | Docker Container | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Integration Tests
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "| ðŸ§© Integration Tests | âœ… Success | Docker + PostgreSQL | All integration tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
          echo "| ðŸ§© Integration Tests | âŒ Failed | Docker + PostgreSQL | Check integration test results |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.integration-tests.result }}" == "skipped" ]]; then
          echo "| ðŸ§© Integration Tests | â­ï¸ Skipped | Docker + PostgreSQL | Previous job failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ§© Integration Tests | âš ï¸ Unknown | Docker + PostgreSQL | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # E2E Tests
        if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "| ðŸŒ E2E Tests | âœ… Success | Full Docker Stack | All end-to-end tests passed |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.e2e-tests.result }}" == "failure" ]]; then
          echo "| ðŸŒ E2E Tests | âŒ Failed | Full Docker Stack | Check E2E test results |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
          echo "| ðŸŒ E2E Tests | â­ï¸ Skipped | Full Docker Stack | Previous job failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸŒ E2E Tests | âš ï¸ Unknown | Full Docker Stack | Unexpected status |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Docker Images Built" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ³ **flowershop-base** - Base .NET 7.0 SDK image with dependencies" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ³ **flowershop-app** - Application runtime image" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ³ **flowershop-tests** - Test runner image" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ³ **postgres:15** - Database image" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Test Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All test results are available as downloadable artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“„ **unit-test-results** - Unit test TRX files" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“„ **integration-test-results** - Integration test TRX files" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“„ **e2e-test-results** - E2E test TRX files" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
        if [[ "${{ github.event.pull_request.head.repo.full_name != github.repository && github.event_name == 'pull_request' }}" == "true" ]]; then
          echo "> ðŸ”’ **Security Notice**: Detailed test reports are limited for pull requests from forks." >> $GITHUB_STEP_SUMMARY
          echo "> Test artifacts are available for download in the workflow run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.build-and-test.result }}" == "success" && "${{ needs.integration-tests.result }}" == "success" && "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "ðŸŽ‰ **All Docker tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… The application has been successfully built and tested in Docker containers." >> $GITHUB_STEP_SUMMARY
          echo "âœ… All unit, integration, and end-to-end tests are passing." >> $GITHUB_STEP_SUMMARY
          echo "âœ… The application is ready for deployment." >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Some tests failed or were skipped.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ“‹ Check the detailed test reports in the artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ” Review failed tests and fix the issues" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ”„ Re-run the pipeline after implementing fixes" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ³ Verify Docker container logs for any runtime issues" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*ðŸ³ Docker-based test report generated automatically by GitHub Actions*" >> $GITHUB_STEP_SUMMARY